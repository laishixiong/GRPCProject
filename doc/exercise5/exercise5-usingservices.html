<!DOCTYPE html>
<!-- saved from url=(0079)https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html -->
<html class=" js flexbox canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers no-applicationcache svg inlinesvg smil svgclippaths" lang="en" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using Kubernetes Services — gRPC Chatroom Workshop  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="./exercise5-usingservices_files/custom.css" type="text/css">
  <link rel="stylesheet" href="./exercise5-usingservices_files/pygments.css" type="text/css">
    <link rel="index" title="Index" href="https://retroryan8080.gitlab.io/grpc-java-workshop/genindex.html">
    <link rel="search" title="Search" href="https://retroryan8080.gitlab.io/grpc-java-workshop/search.html">
    <link rel="next" title="Kubernetes Deployment" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/deployment.html">
    <link rel="prev" title="Deploy a Kubernetes Cluster" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/deploykubernetes.html"> 

  
  <script src="./exercise5-usingservices_files/modernizr.min.js.download"></script><style type="text/css">
:root .btn[href*="/viphktv.com/"],
:root .btn[href*=".papa9394.com"],
:root .btn.btn-success.text-white[href*=".com:"]
{ display: none !important; }</style>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="https://retroryan8080.gitlab.io/grpc-java-workshop/index.html" class="icon icon-home"> gRPC Chatroom Workshop
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://retroryan8080.gitlab.io/grpc-java-workshop/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/setup/setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise1/exercise1.html">Exercise 1 - Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise2/exercise2.html">Exercise 2 - Implement Stubs</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise3/exercise3.html">Exercise 3 - Testing the Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise4/exercise4.html">Exercise 4 - Bidirectional Streaming</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/exercise5.html"><span class="toctree-expand"></span>Exercise 5 - Deployment to Kubernetes</a><ul class="">
<li class="toctree-l2"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/setup.html">Google Cloud Console Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/deploykubernetes.html">Deploy a Kubernetes Cluster</a></li>
<li class="toctree-l2 current"><a class="reference internal current" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#"><span class="toctree-expand"></span>Using Kubernetes Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#setup-the-environment-file">Setup the Environment File</a></li>
<li class="toctree-l3"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#kubernetes-deployment-descriptors">Kubernetes Deployment Descriptors</a></li>
<li class="toctree-l3"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#update-the-server-urls">Update the Server URLs</a></li>
<li class="toctree-l3"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#update-database-file-location">Update Database File Location</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/deployment.html">Kubernetes Deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise6/exercise6.html">Exercise 6 - Metadata and Interceptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise7/exercise7.html">Exercise 7 - Context Propagation</a></li>
<li class="toctree-l1"><a class="reference internal" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise8/exercise8.html">Exercise 8 - Tracing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="https://retroryan8080.gitlab.io/grpc-java-workshop/index.html">gRPC Chatroom Workshop</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="https://retroryan8080.gitlab.io/grpc-java-workshop/index.html">Docs</a> »</li>
        
          <li><a href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/exercise5.html">Exercise 5 - Deployment to Kubernetes</a> »</li>
        
      <li>Using Kubernetes Services</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="https://retroryan8080.gitlab.io/grpc-java-workshop/_sources/exercise5/usingservices.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-kubernetes-services">
<h1>Using Kubernetes Services<a class="headerlink" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#using-kubernetes-services" title="Permalink to this headline">¶</a></h1>
<p>In this exercise we are going to modify the server URL’s from being hard code to localhost to using ones injected by kubernetes.</p>
<p>This will allow the application to use Kubernetes Service names to discover the other microservices to call.</p>
<div class="section" id="setup-the-environment-file">
<h2>Setup the Environment File<a class="headerlink" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#setup-the-environment-file" title="Permalink to this headline">¶</a></h2>
<p>This code will look for an environment variable for the host name or use a default.</p>
<p>Look at the EnvVars file in  com.example.auth.EnvVars</p>
</div>
<div class="section" id="kubernetes-deployment-descriptors">
<h2>Kubernetes Deployment Descriptors<a class="headerlink" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#kubernetes-deployment-descriptors" title="Permalink to this headline">¶</a></h2>
<p>Be sure you have all the kubernetes deployment files in the kubernetes folder.  If they are missing copy them from this folder:</p>
<p><a class="reference external" href="https://github.com/retroryan/grpc-java-chatroom-workshop/tree/solution/kubernetes">kubernetes folder</a></p>
</div>
<div class="section" id="update-the-server-urls">
<h2>Update the Server URLs<a class="headerlink" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#update-the-server-urls" title="Permalink to this headline">¶</a></h2>
<p>All of the URLs in the code base need to be updated to use the environment vars.</p>
<ul class="simple">
<li>Auth Service - Update the port that the auth service starts on from the environment variables:</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Server server = ServerBuilder.forPort(EnvVars.AUTH_SERVICE_PORT)</span>
<span class="go">       .addService(new AuthServiceImpl(repository, "auth-issuer", algorithm))</span>
<span class="go">       .build();</span>
</pre></div>
</div>
<ul class="simple">
<li>Chat Service - Update the port that the chat service uses to connect to the auth service to use environment variables:</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">final ManagedChannel authChannel = ManagedChannelBuilder.forTarget(EnvVars.AUTH_SERVICE_URL)</span>
<span class="go">     .usePlaintext()</span>
<span class="go">     .build();</span>
</pre></div>
</div>
<ul class="simple">
<li>Chat Service - Update the port that the chat service starts on from the environment variables:</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">final Server server = ServerBuilder.forPort(EnvVars.CHAT_SERVICE_PORT)</span>
<span class="go">    .addService(chatRoomService)</span>
<span class="go">    .addService(chatStreamService)</span>
<span class="go">    .build();</span>
</pre></div>
</div>
<ul class="simple">
<li>Chat Client - Update the port that the chat client uses to connect to the auth service to use environment variables:</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">authChannel = ManagedChannelBuilder.forTarget(EnvVars.AUTH_SERVICE_URL)</span>
<span class="go">      .usePlaintext()</span>
<span class="go">      .build();</span>
</pre></div>
</div>
<ul class="simple">
<li>Chat Client - Update the port that the chat client uses to connect to the chat service to use environment variables:</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">chatChannel = ManagedChannelBuilder.forTarget(EnvVars.CHAT_SERVICE_URL)</span>
<span class="go">    .usePlaintext()</span>
<span class="go">    .build();</span>
</pre></div>
</div>
</div>
<div class="section" id="update-database-file-location">
<h2>Update Database File Location<a class="headerlink" href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/usingservices.html#update-database-file-location" title="Permalink to this headline">¶</a></h2>
<p>Update how the User Repository database file name has been updated in this file to use an environment variable:</p>
<p>In the file and method com.example.auth.repository.UserRepository#getOrCreateFile  change it to be:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">String filePath = EnvVars.DATABASE_PATH + "/" + FILENAME;</span>
<span class="go">logger.info("loading users database file from path: " + filePath);</span>
<span class="go">File file = new File(filePath);</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/deployment.html" class="btn btn-neutral float-right" title="Kubernetes Deployment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="https://retroryan8080.gitlab.io/grpc-java-workshop/exercise5/deploykubernetes.html" class="btn btn-neutral" title="Deploy a Kubernetes Cluster" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr>

  <div role="contentinfo">
    <p>
        © Copyright 2017, Ryan Knight, Ray Tsang.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="./exercise5-usingservices_files/jquery.js.download"></script>
      <script type="text/javascript" src="./exercise5-usingservices_files/underscore.js.download"></script>
      <script type="text/javascript" src="./exercise5-usingservices_files/doctools.js.download"></script>

  

  <script type="text/javascript" src="./exercise5-usingservices_files/theme.js.download"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 


</body></html>